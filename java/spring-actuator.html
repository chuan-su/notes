<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js rust">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Spring Actuator</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="../index.html">Chuan's Notes</a></li><li class="chapter-item expanded "><a href="../java/index.html"><strong aria-hidden="true">1.</strong> Java</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../java/reduce.html"><strong aria-hidden="true">1.1.</strong> reduce</a></li><li class="chapter-item "><a href="../java/foldleft.html"><strong aria-hidden="true">1.2.</strong> foldleft</a></li><li class="chapter-item expanded "><a href="../java/spring-actuator.html" class="active"><strong aria-hidden="true">1.3.</strong> Spring Actuator</a></li><li class="chapter-item "><a href="../java/swagger.html"><strong aria-hidden="true">1.4.</strong> Swagger</a></li><li class="chapter-item "><a href="../java/freemarker.html"><strong aria-hidden="true">1.5.</strong> FreeMarker</a></li></ol></li><li class="chapter-item "><a href="../docker/index.html"><strong aria-hidden="true">2.</strong> Docker</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../docker/dockerfile.html"><strong aria-hidden="true">2.1.</strong> Dockerfile</a></li><li class="chapter-item "><a href="../docker/volume.html"><strong aria-hidden="true">2.2.</strong> volume</a></li><li class="chapter-item "><a href="../docker/network.html"><strong aria-hidden="true">2.3.</strong> network</a></li><li class="chapter-item "><a href="../docker/dockerrun.html"><strong aria-hidden="true">2.4.</strong> docker run</a></li></ol></li><li class="chapter-item "><a href="../linux/index.html"><strong aria-hidden="true">3.</strong> Linux</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../linux/volume.html"><strong aria-hidden="true">3.1.</strong> Volume</a></li><li class="chapter-item "><a href="../linux/void.html"><strong aria-hidden="true">3.2.</strong> Void Linux</a></li><li class="chapter-item "><a href="../linux/netcat.html"><strong aria-hidden="true">3.3.</strong> netcat</a></li></ol></li><li class="chapter-item "><a href="../aws/index.html"><strong aria-hidden="true">4.</strong> AWS</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../aws/ebs.html"><strong aria-hidden="true">4.1.</strong> EBS</a></li><li class="chapter-item "><a href="../aws/ec2.html"><strong aria-hidden="true">4.2.</strong> EC2</a></li><li class="chapter-item "><a href="../aws/iam.html"><strong aria-hidden="true">4.3.</strong> IAM</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../aws/iamrole.html"><strong aria-hidden="true">4.3.1.</strong> IAM Role</a></li></ol></li><li class="chapter-item "><a href="../aws/kms.html"><strong aria-hidden="true">4.4.</strong> KMS</a></li><li class="chapter-item "><a href="../aws/vpc.html"><strong aria-hidden="true">4.5.</strong> VPC</a></li><li class="chapter-item "><a href="../aws/elb.html"><strong aria-hidden="true">4.6.</strong> ELB</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../aws/auto-scaling.html"><strong aria-hidden="true">4.6.1.</strong> Auto Scaling</a></li></ol></li><li class="chapter-item "><a href="../aws/route53.html"><strong aria-hidden="true">4.7.</strong> Route 53</a></li><li class="chapter-item "><a href="../aws/global-accelerator.html"><strong aria-hidden="true">4.8.</strong> Global Accelerator</a></li><li class="chapter-item "><a href="../aws/cloudfront.html"><strong aria-hidden="true">4.9.</strong> CloudFront</a></li><li class="chapter-item "><a href="../aws/lambda.html"><strong aria-hidden="true">4.10.</strong> Lambda</a></li><li class="chapter-item "><a href="../aws/s3.html"><strong aria-hidden="true">4.11.</strong> S3</a></li><li class="chapter-item "><a href="../aws/replication.html"><strong aria-hidden="true">4.12.</strong> Data Replication</a></li><li class="chapter-item "><a href="../aws/elasticache.html"><strong aria-hidden="true">4.13.</strong> ElastiCache</a></li><li class="chapter-item "><a href="../aws/security.html"><strong aria-hidden="true">4.14.</strong> Security</a></li><li class="chapter-item "><a href="../aws/misc.html"><strong aria-hidden="true">4.15.</strong> Misc</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="spring-actuator"><a class="header" href="#spring-actuator">Spring Actuator</a></h1>
<p><a href="https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html">Spring Actuator</a> enables many production-ready features for your Spring Boot Applications such as health checks, metrics gathering.</p>
<pre><code class="language-xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre>
<h2 id="health-checks"><a class="header" href="#health-checks">Health Checks</a></h2>
<p>When deploying applications to a kubenetes cluster, it is ofter necessary to configure <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/">Liveness, Readiness probes</a>.</p>
<p>The differences between <code>liveness probs</code> and <code>readiness probes</code> are, as follows:</p>
<ul>
<li>The <a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/">kubelet</a> uses liveness probes to know when to <strong>restart</strong> a container.</li>
<li>The kubelet uses readiness probes to determine when a container is ready to start accepting traffic.</li>
</ul>
<p>Spring Actuator exposes both liveness and readiness check endpoints. However, it is important to undertand what to be included in which health group - liveness or readiness.</p>
<p>Considering an Spring Boot application that connects to a Postgres or MySQL database, if the database itself is in outage, restarting the application will not solve the database issues. Therefore, the database health check should not be included in the <code>liveness</code> group. Rather, we want to prevent the container from accepting traffics by including the databae health check in the <code>readiness</code> group.</p>
<pre><code class="language-txt">management.server.port=9000
management.endpoints.web.exposure.include=info,health
management.endpoint.health.enabled=true
management.endpoint.health.show-details=always
management.endpoint.health.probes.enabled=true
management.endpoint.health.group.readiness.include=readinessState,db
</code></pre>
<p>The <code>readinessState</code> is what Spring Boot use to represent whether the application is ready to accept traffic or not. Similaly, the <code>livenessState</code> represents the liveness of the application and the correctness ofits internal state.</p>
<p>Therefore, the container readiness to accept traffics is dependent on both the application internal state and the database status.</p>
<p>To check the application readiness, you can go to <a href="http://localhost:9000/actuator/health/readiness">localhost:9000/actuator/health/readiness</a>, which is also what you should configure in the kubenetes readiness probs.</p>
<pre><code class="language-yaml">livenessProbe:
  httpGet:
    path: /actuator/health/liveness
    scheme: HTTP
    port: 9000
  initialDelaySeconds: 45
  timeoutSeconds: 40
readinessProbe:
  httpGet:
    path: /actuator/health/readiness
    scheme: HTTP 
    port: 9000
  initialDelaySeconds: 60
  timeoutSeconds: 10
</code></pre>
<h3 id="custom-health-checks"><a class="header" href="#custom-health-checks">Custom Health Checks</a></h3>
<p>To implement custom health checks, you can extend the Spring <a href="https://docs.spring.io/spring-boot/docs/current/api/org/springframework/boot/actuate/health/AbstractHealthIndicator.html">AbstractHealthIndicator</a> class.</p>
<p>However, for applications that use non-blocking clients, for intance, <a href="https://lettuce.io/">Lettuce</a> for Redis. You need to instead extend the Spring <a href="https://docs.spring.io/spring-boot/docs/current/api/org/springframework/boot/actuate/health/AbstractReactiveHealthIndicator.html">AbstractReactiveHealthIndicator</a>. </p>
<pre><code class="language-java">import io.lettuce.core.RedisConnectionException;
import io.lettuce.core.api.StatefulRedisConnection;
import org.springframework.boot.actuate.health.AbstractReactiveHealthIndicator;
import org.springframework.boot.actuate.health.Health;
import org.springframework.boot.actuate.health.Health.Builder;
import org.springframework.context.annotation.Configuration;
import reactor.core.publisher.Mono;

import java.io.IOException;
import java.io.StringReader;
import java.util.Properties;

@Configuration(proxyBeanMethods = false)
public class RedisHealthIndicator extends AbstractReactiveHealthIndicator {

  private final StatefulRedisConnection&lt;String, String&gt; connection;

  public RedisHealthIndicator(StatefulRedisConnection&lt;String, String&gt; connection) {
    super(&quot;Redis health check failed&quot;);
    this.connection = connection;
  }

  @Override
  protected Mono&lt;Health&gt; doHealthCheck(Builder builder) {

    if (!connection.isOpen()) {
      return Mono.just(this.down(builder, new RedisConnectionException(&quot;unable to connect&quot;)));
    }

    return connection.reactive().info(&quot;server&quot;)
        .map(info -&gt; {
          final Properties p = new Properties();
          try {
            p.load(new StringReader(info));
          } catch (IOException e) {
            LOG.warn(&quot;failed to load redis server properties&quot;, e);
          }
          return this.up(builder, p);
        })
        .onErrorResume(throwable -&gt; Mono.just(this.down(builder, throwable)));
  }

  private Health up(Builder builder, Properties info) {
    return builder.up().withDetail(&quot;server&quot;, info).build();
  }

  private Health down(Builder builder, Throwable cause) {
    return builder.down(cause).build();
  }
</code></pre>
<p>After having created the custom health indicator, you need to add it to the health group:</p>
<pre><code class="language-txt">management.endpoint.health.group.readiness.include=readinessState,redis,db
</code></pre>
<p><strong>Note that</strong> the naming needs to correspond to the class name. For example, if you have <code>PubsubHealthUbducator.java</code>, then you need to have <code>include=pubsub</code> in the actuator configuration. If you have <code>PubSubHealthIndicator.java</code>, then you need to have camel case <code>include=pubSub</code>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../java/foldleft.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../java/swagger.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../java/foldleft.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../java/swagger.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
