<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>FreeMarker</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Chuan's Notes</a></li><li class="chapter-item expanded "><a href="../java/index.html"><strong aria-hidden="true">1.</strong> Java</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../java/reduce.html"><strong aria-hidden="true">1.1.</strong> reduce</a></li><li class="chapter-item expanded "><a href="../java/foldleft.html"><strong aria-hidden="true">1.2.</strong> foldleft</a></li><li class="chapter-item expanded "><a href="../java/spring-actuator.html"><strong aria-hidden="true">1.3.</strong> Spring Actuator</a></li><li class="chapter-item expanded "><a href="../java/swagger.html"><strong aria-hidden="true">1.4.</strong> Swagger</a></li><li class="chapter-item expanded "><a href="../java/freemarker.html" class="active"><strong aria-hidden="true">1.5.</strong> FreeMarker</a></li></ol></li><li class="chapter-item expanded "><a href="../docker/index.html"><strong aria-hidden="true">2.</strong> Docker</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../docker/dockerfile.html"><strong aria-hidden="true">2.1.</strong> Dockerfile</a></li><li class="chapter-item expanded "><a href="../docker/volume.html"><strong aria-hidden="true">2.2.</strong> volume</a></li><li class="chapter-item expanded "><a href="../docker/network.html"><strong aria-hidden="true">2.3.</strong> network</a></li><li class="chapter-item expanded "><a href="../docker/dockerrun.html"><strong aria-hidden="true">2.4.</strong> docker run</a></li></ol></li><li class="chapter-item expanded "><a href="../linux/index.html"><strong aria-hidden="true">3.</strong> Linux</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../linux/volume.html"><strong aria-hidden="true">3.1.</strong> Volume</a></li><li class="chapter-item expanded "><a href="../linux/void.html"><strong aria-hidden="true">3.2.</strong> Void Linux</a></li><li class="chapter-item expanded "><a href="../linux/netcat.html"><strong aria-hidden="true">3.3.</strong> netcat</a></li></ol></li><li class="chapter-item expanded "><a href="../aws/index.html"><strong aria-hidden="true">4.</strong> AWS</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../aws/ebs.html"><strong aria-hidden="true">4.1.</strong> EBS</a></li><li class="chapter-item expanded "><a href="../aws/ec2.html"><strong aria-hidden="true">4.2.</strong> EC2</a></li><li class="chapter-item expanded "><a href="../aws/iam.html"><strong aria-hidden="true">4.3.</strong> IAM</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../aws/iamrole.html"><strong aria-hidden="true">4.3.1.</strong> IAM Role</a></li></ol></li><li class="chapter-item expanded "><a href="../aws/kms.html"><strong aria-hidden="true">4.4.</strong> KMS</a></li><li class="chapter-item expanded "><a href="../aws/vpc.html"><strong aria-hidden="true">4.5.</strong> VPC</a></li><li class="chapter-item expanded "><a href="../aws/elb.html"><strong aria-hidden="true">4.6.</strong> ELB</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../aws/auto-scaling.html"><strong aria-hidden="true">4.6.1.</strong> Auto Scaling</a></li></ol></li><li class="chapter-item expanded "><a href="../aws/route53.html"><strong aria-hidden="true">4.7.</strong> Route 53</a></li><li class="chapter-item expanded "><a href="../aws/global-accelerator.html"><strong aria-hidden="true">4.8.</strong> Global Accelerator</a></li><li class="chapter-item expanded "><a href="../aws/cloudfront.html"><strong aria-hidden="true">4.9.</strong> CloudFront</a></li><li class="chapter-item expanded "><a href="../aws/lambda.html"><strong aria-hidden="true">4.10.</strong> Lambda</a></li><li class="chapter-item expanded "><a href="../aws/s3.html"><strong aria-hidden="true">4.11.</strong> S3</a></li><li class="chapter-item expanded "><a href="../aws/replication.html"><strong aria-hidden="true">4.12.</strong> Data Replication</a></li><li class="chapter-item expanded "><a href="../aws/elasticache.html"><strong aria-hidden="true">4.13.</strong> ElastiCache</a></li><li class="chapter-item expanded "><a href="../aws/security.html"><strong aria-hidden="true">4.14.</strong> Security</a></li><li class="chapter-item expanded "><a href="../aws/misc.html"><strong aria-hidden="true">4.15.</strong> Misc</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        

                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="create-a-maven-plugin-with-freemarker"><a class="header" href="#create-a-maven-plugin-with-freemarker">Create a Maven Plugin with FreeMarker</a></h1>
<p>Sometimes it is quite convinent to generate Java source code from a specification, such as from a <code>.yaml</code> file. </p>
<p>You can create a maven plugin to read the <code>.yaml</code> specification and generate the Java source code into the <code>target/generated-sources/</code> directory using <a href="https://freemarker.apache.org/">FreeMarker</a>, a Java Template Engine.</p>
<p>To create a maven plugin with freemarker, you need the following dependencies. And you will typically name your plugin <code>&lt;yourplugin&gt;-maven-plugin</code>.</p>
<pre><code class="language-xml">  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.apache.maven&lt;/groupId&gt;
      &lt;artifactId&gt;maven-plugin-api&lt;/artifactId&gt;
      &lt;version&gt;3.6.3&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.apache.maven.plugin-tools&lt;/groupId&gt;
      &lt;artifactId&gt;maven-plugin-annotations&lt;/artifactId&gt;
      &lt;version&gt;3.6.0&lt;/version&gt;
      &lt;scope&gt;provided&lt;/scope&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.apache.maven&lt;/groupId&gt;
      &lt;artifactId&gt;maven-project&lt;/artifactId&gt;
      &lt;version&gt;2.2.1&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.freemarker&lt;/groupId&gt;
      &lt;artifactId&gt;freemarker&lt;/artifactId&gt;
      &lt;version&gt;2.3.30&lt;/version&gt;
    &lt;/dependency&gt;
  &lt;/dependencies&gt;
</code></pre>
<p>As an example, we are going to create a maven plugin named <code>client-notification-maven-plugin</code> which reads a <code>YAML</code> specification and generates Java source code.</p>
<h2 id="mojo"><a class="header" href="#mojo">Mojo</a></h2>
<p>To create the plugin, we need to first create a Java mojo class representing the plugin's goals <code>generate</code>.</p>
<pre><code class="language-java">@Mojo(name = &quot;generate&quot;, defaultPhase = LifecyclePhase.GENERATE_SOURCES)
public class ClientNotificationMojo extends AbstractMojo {
}
</code></pre>
<p>To use the plugin in other Java projects, we need to specify the corresponding goal <code>generate</code> , as follows</p>
<pre><code class="language-xml">&lt;build&gt;
  &lt;plugins&gt;
    &lt;plugin&gt;
      &lt;groupId&gt;com.lakritsoft&lt;/groupId&gt;
      &lt;artifactId&gt;client-notification-maven-plugin&lt;/artifactId&gt;
      &lt;executions&gt;
        &lt;execution&gt;
          &lt;goals&gt;
            &lt;goal&gt;generate&lt;/goal&gt;
          &lt;/goals&gt;
        &lt;/execution&gt;
      &lt;/executions&gt;
    &lt;/plugin&gt;
  &lt;/plugins&gt;
&lt;/build&gt;
</code></pre>
<h3 id="package-of-generated-source-code"><a class="header" href="#package-of-generated-source-code">Package of generated source code</a></h3>
<p>When generating the Java source code, it is often desired to specify the Java package. </p>
<p>Assume the project has the groupId and artifactId below:</p>
<pre><code class="language-xml">&lt;groupId&gt;com.lakritsoft.myservice&lt;/groupId&gt;
&lt;artifactId&gt;app&lt;/artifactId&gt;
</code></pre>
<p>And we want the generated the souce code to be located at <code>com.lakritsoft.myservice.clientnotification</code> package.</p>
<pre><code class="language-xml">app/
  target/
    generated-sources/
      client-notification/
	java/
          com.lakritsoft.myservice.clientnotification // package name
  pom.xml
pom.xml
</code></pre>
<p>To find out the project groupId and specify the source package:</p>
<pre><code class="language-java">@Mojo(name = &quot;generate&quot;, defaultPhase = LifecyclePhase.GENERATE_SOURCES)
public class ClientNotificationMojo extends AbstractMojo {

  @Parameter(defaultValue = &quot;target/generated-sources/client-notification/java&quot;)
  private File outputDirectory;

  @Parameter(
      defaultValue = &quot;${project}&quot;,
      required = true,
      readonly = true)
  private MavenProject project
  
  @Override
  public void execute() throws MojoExecutionException, MojoFailureException {
    String srcPackage = project.getGroupId() + &quot;.&quot; + &quot;clientnotification&quot;;
    File srcDir = new File(outputDirectory, srcPackage.replace(&quot;.&quot;, &quot;/&quot;));

    srcDir.mkdirs();

    project.addCompileSourceRoot(outputDirectory.getAbsolutePath());  
  }
}
</code></pre>
<h3 id="read-the-yaml-specification-from-the-java-mojo-class"><a class="header" href="#read-the-yaml-specification-from-the-java-mojo-class">Read the YAML specification from the Java Mojo Class</a></h3>
<p>If the <code>YAML</code> specifications is published to Maven artifact repository, such as Nexus, as <code>zip</code> format, we can use <code>maven-dependecy-plugin</code> to unpack the zip file.</p>
<pre><code class="language-xml"> &lt;build&gt;
    &lt;plugins&gt;
      &lt;plugin&gt;
        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
        &lt;artifactId&gt;maven-plugin-plugin&lt;/artifactId&gt;
        &lt;version&gt;3.6.0&lt;/version&gt;
      &lt;/plugin&gt;
      &lt;plugin&gt;
        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
        &lt;artifactId&gt;maven-dependency-plugin&lt;/artifactId&gt;
        &lt;executions&gt;
          &lt;execution&gt;
            &lt;id&gt;unpack-yaml-specification&lt;/id&gt;
            &lt;goals&gt;
              &lt;goal&gt;unpack&lt;/goal&gt;
            &lt;/goals&gt;
            &lt;phase&gt;compile&lt;/phase&gt;
            &lt;configuration&gt;
              &lt;artifactItems&gt;
                &lt;artifactItem&gt;
                  &lt;groupId&gt;com.example&lt;/groupId&gt;
                  &lt;artifactId&gt;yaml-specification&lt;/artifactId&gt;
                  &lt;version&gt;${version}&lt;/version&gt;
                  &lt;type&gt;zip&lt;/type&gt;
                  &lt;outputDirectory&gt;${project.build.directory}/classes/specs&lt;/outputDirectory&gt;
                  &lt;includes&gt;specification.yaml&lt;/includes&gt;
                &lt;/artifactItem&gt;
              &lt;/artifactItems&gt;
            &lt;/configuration&gt;
          &lt;/execution&gt;
        &lt;/executions&gt;
      &lt;/plugin&gt;
    &lt;/plugins&gt;
  &lt;/build&gt;
</code></pre>
<p>With <code>maven-dependency-plugin</code>, We unpack the YAML files into the project <code>classpath</code> - <code>app/target/classes/specs</code>.</p>
<p>And to read the YAML file, we can ues Java <code>ClassLoader</code>:</p>
<pre><code class="language-java">@Mojo(name = &quot;generate&quot;, defaultPhase = LifecyclePhase.GENERATE_SOURCES)
public class ClientNotificationMojo extends AbstractMojo {

  @Override
  public void execute() throws MojoExecutionException, MojoFailureException {

     InputStream is =
        this.getClass().getClassLoader().getResourceAsStream(&quot;specs/specification.yaml&quot;);

  }
}
</code></pre>
<h2 id="freemarker"><a class="header" href="#freemarker">FreeMarker</a></h2>
<p>We have now covered how to create the src package for the generated clasess, and how to read YAML files.
Next step is to generate the Java source files using FreeMaker template engine.</p>
<p>We create the template files and put them inside the <code>resources</code> directory: </p>
<pre><code class="language-txt">client-notification-maven-plugin
  src/
    main/
      java/
      resources/ 
        tempaltes/
          ExampleJava.ftlh
</code></pre>
<p>The content of the <code>ExampleJava.ftlh</code> is as follows:</p>
<pre><code class="language-java">package ${package};

public class ExampleJava {

}
</code></pre>
<p>Then in our Java Mojo class, we can process the template and generate the <code>ExampleJava.java</code> source file:</p>
<pre><code class="language-java">  Configuration cfg = new Configuration(Configuration.VERSION_2_3_29);
  cfg.setNumberFormat(&quot;computer&quot;);

  try {
      cfg.setClassForTemplateLoading(this.getClass(), &quot;/templates/&quot;);

      Template temp = cfg.getTemplate(&quot;ExampleJava.ftlh&quot;);
      temp.process(Map.of(&quot;package&quot;, srcPackage), new FileWriter(new File(srcDir, &quot;ExampleJava.java&quot;)));

    } catch (IOException | TemplateException e) {
      getLog().error(e);
      throw new RuntimeException(e);
    }
</code></pre>
<p>With FreeMarker, you can perform <code>if</code> condition and loop through a Java collection to generate dynamic content.</p>
<p>One example is that the user of our plugin want to specify a list of notification types and the generated Java source code should be different based on the configuration: </p>
<pre><code class="language-xml">&lt;build&gt;
  &lt;plugins&gt;
    &lt;plugin&gt;
      &lt;groupId&gt;com.lakritsoft&lt;/groupId&gt;
      &lt;artifactId&gt;client-notification-maven-plugin&lt;/artifactId&gt;
      &lt;executions&gt;
        &lt;execution&gt;
          &lt;goals&gt;
            &lt;goal&gt;generate&lt;/goal&gt;
          &lt;/goals&gt;
	  &lt;configuration&gt;
             &lt;notificationTypes&gt;
                &lt;notificationType&gt;EMAIL&lt;/notificationType&gt;
                &lt;notificationType&gt;SMS&lt;/notificationType&gt;
                &lt;notificationType&gt;WEB_SOCKET&lt;/notificationType&gt;
              &lt;/notificationTypes&gt;
          &lt;/configuration&gt;
        &lt;/execution&gt;
      &lt;/executions&gt;
    &lt;/plugin&gt;
  &lt;/plugins&gt;
&lt;/build&gt;
</code></pre>
<p>We can read the user-specified <code>notificationTypes</code> configuration inside the Mojo class:</p>
<pre><code class="language-java">@Mojo(name = &quot;generate&quot;, defaultPhase = LifecyclePhase.GENERATE_SOURCES)
public class ClientNotificationMojo extends AbstractMojo {

  @Parameter(
      property = &quot;notificationTypes&quot;,
      required = false,
      readonly = true)
  private String[] notificationTypes 
}
</code></pre>
<p>We can then pass the <code>notificationTypes</code> further to the FreeMarker template:</p>
<pre><code class="language-java">Map&lt;String, Object&gt; options = Map.of(&quot;package&quot;, srcPackage, &quot;notificationTypes&quot;, notificationTypes);

temp.process(options, new FileWriter(new File(srcDir, &quot;ExampleJava.java&quot;)));
</code></pre>
<p>Inside the <code>.ftlh</code> file, we can loop the notification <code>java.util.List</code> as</p>
<pre><code class="language-java">package ${package};

public class ExampleJava {
  &lt;#list notificationTypes as no&gt;
     &lt;#assign idx = no?index&gt;
     .....
     .....
  &lt;/#list&gt;
}
</code></pre>
<p>You can read more about FreeMarker directives at <a href="https://freemarker.apache.org/docs/index.html">Apache FreeMarker Manual</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../java/swagger.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../docker/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../java/swagger.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../docker/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
